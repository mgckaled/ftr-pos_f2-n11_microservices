# Transcrição: 6. Tracing Distribuído

Uma coisa que é muito importante quando a gente vai trabalhar com microserviços é observabilidade, porque imagina que quando o usuário vai fazer uma requisição do front aqui para o seu API Gateway, imagina que isso aqui fosse um monolito, onde você não tivesse microserviços. Você concorda comigo que a requisição só tem um ponto de entrada e ela vai chegar até o banco de dados e depois vai voltar até o ponto de entrada, né? Então, imagine que o usuário selecionou que ele quer criar um usuário ou criar uma URL. Ele vai simplesmente chegar, vai bater no back-end, o back-end vai bater no banco, vai voltar para o back-end, vai voltar para o front-end e pronto. Ou seja, é uma linha sempre, né? Sempre vai ser uma linha, uma ida e uma volta. Só que quando a gente trabalha com... microserviços, nem sempre vai ser assim. Porque eu posso ter o front-end chamando API Gateway, que vai chamar um serviço, esse serviço vai disparar uma mensagem assíncrona para um outro serviço que vai se comunicar com o banco de dados e depois vai voltar, vai falar com outro serviço que vai voltar... Então, tem um serviço comunicando com o outro, comunicando com o outro, essa comunicação pode ser assíncrona, pode ser síncrona... E isso começa a virar um problema, porque imagina que daqui a pouco, quando a gente cria uma URL, está dando um problema lá na inserção dessa URL dentro do Analytics, e se a gente não tiver a observabilidade bem configurada para saber qual requisição que está acontecendo isso... Então, imagina uma requisição que ela iniciou no front, foi para o serviço de encurtamento, depois ela fez uma chamada assíncrona enviando um evento de URL created para o meu broker, essa mensagem foi ouvida pelo evento de analytics que processou e tentou inserir no banco e deu erro. Só que se eu tiver observabilidade somente nesse app aqui e chegar só no ponto de, opa, tá dando erro no analytics e não saber qual o caminho todo que a mensagem trafegou, provavelmente eu vou ter as informações muito limitadas para conseguir tomar uma decisão na hora de saber onde agir e em como resolver o problema. E por isso, quando a gente vai trabalhar com observabilidade em sistemas distribuídos, é muito importante que a gente siga a ideia de tracing distribuído. Então, o que é tracing distribuído? O tracing distribuído nada mais é do que... Quando uma requisição passa por vários serviços, ela tem que carregar alguma informação com ela que a identifique de forma única quem foi que iniciou essa requisição? Então, imagina que, quando eu fizesse uma requisição aqui do front para API Gateway, imagina que o API Gateway gerasse, por exemplo, um ID, um xRequestId, que poderia ser um UID ou qualquer coisa assim. E esse xRequestId, ele fosse trafegado por toda a minha aplicação, por toda a comunicação, até chegar no final dela. Ou seja, até ela processar tudo que ela tinha que ser processado. Então, o usuário pediu para encurtar uma URL, esse id é enviado. Depois, essa URL gerou uma mensagem no Kafka. esse ID é enviado. Depois, essa mensagem foi recebida pelo consumer do Analytics e esse ID foi enviado. Depois, esse Analytics enviou para outro lugar e esse ID também foi enviado. Ou seja, a gente tem um ID que é usado para referenciar aquela requisição desde o início que ela chegou até aonde ela foi processada lá no final. E é isso que a gente faz quando a gente trabalha com tracing distribuído. Para dessa forma, quando o usuário for visualizar um tracing, que é basicamente uma demonstração de... de todo o fluxo de uma requisição, o que levou mais tempo, chamadas para o banco e tudo mais, ele consiga identificar todos os serviços trabalhando juntos. E aí, se a gente for olhar aqui no nosso código, até eu deixei aqui uma documentação sobre tracing distribuído, onde você consegue entender mais ou menos como isso é feito. Então, aqui tem um gráfico, a gente usa o Open Telemetry, que hoje é a SDK, mundial, mas usada para tracing, para observabilidade. E o que acontece é, o Node tem um pacote de auto-instrumentation, de instrumentação automática. Esse pacote aqui, ele automaticamente já faz o tracing para todas as ferramentas mais comuns do Node. Então, por exemplo, se a gente for olhar aqui embaixo, A gente vê que ele faz tracing automático para o AMPQ, AMQP Lib, que é se você estiver usando RabbitMQ, AWS SDK, FastFi, Express, GraphQL, gRPC, que é o que a gente está usando bastante aqui, que a gente usaria bastante no microserviço, HTTP, é pg né banco de dados postgres então se você estiver usando mesmo que ele esteja atrás de um prisma dum drizzle ou qualquer coisa assim mongodb e olha só aqui embaixo também kafka.js né então ele automaticamente já faz esse tracing distribuído para gente é só você configurar o tracer em todas as aplicações então se eu for ver aqui todos os apps dessa da minha da minha stack aqui no package.json eu faço esse require aqui no auto instrumentations node no script de execução de dev e poderia botar no start de produção também isso automaticamente já vai fazer com que todo o serviço esteja com tracing registrado com essa instrumentação automática E toda operação que acontecer em qualquer um desses serviços, inclusive as comunicações via Kafka, via RabbitMQ, já sejam automaticamente rastreadas pelo nosso Tracer. E aqui tem mais algumas informações dentro dessa documentação. Isso, como eu falei, acontece de forma automatizada. Eu não preciso mexer em nada no código. Apenas caso você esteja utilizando alguma biblioteca que não esteja naquela lista de instrumentações automáticas e que você queira visualizar no tracing... Então, sei lá... Até o Redis faria, mas sei lá... Estou usando um sistema de mensageria que não é nem o Kafka, nem o RabbitMQ... Sei lá, dificilmente aconteceria... Aí você teria que realmente fazer a configuração manual. Mas na maioria das vezes é só adicionar essa linha e toda a parte de instrumentação aqui vai ser configurada automaticamente dentro da sua aplicação. E aí, claro, você precisa ter uma aplicação para visualizar os traces. E aí, localmente, geralmente, você acaba utilizando o Jagger, mas como você vai ter aí nas aulas, ou já teve até algumas passagens sobre isso, o Grafana em produção, que com certeza é a melhor opção. E aí, você vai simplesmente acessar o Jagger e você vai ter todos os seus serviços, e aí você vai conseguir visualizar todos os seus traces aqui disponíveis para conseguir visualizar por onde eles passaram, as chamadas, as requisições que foram feitas no banco de dados... E tudo isso vai estar disponível para você conseguir visualizar pela interface.
