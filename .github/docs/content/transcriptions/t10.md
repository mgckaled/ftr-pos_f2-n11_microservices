# Transcrição: 10. CQRS e Event Sourcing

A outra forma de a gente resolver essa problemática de buscar dados em múltiplos serviços é com um pattern que é muito comumente utilizado dentro de microserviços, que é CQRS. Então, CQRS, assim como o Backend for Frontend, só com abordagens diferentes, visa resolver o problema de como implementar uma query, uma busca, que busca dados de múltiplos serviços dentro de uma arquitetura de microserviços. E o que a gente faz nesse caso com o CQRS é nós dividimos... CQRS vem da sigla... Comand Query Responsibility Segregation Comand Query Responsibility Segregation Por que que aqui não é um A? Se é responsabilidade, por que que traduziram? Por que que no português não é responsabilidade? Ia ficar mais fácil da gente saber Mas... Se a gente for traduzir isso aqui para o português, basicamente é nós separarmos a responsabilidade de comandos e queries. Não sei como é que é queries no português, mas... O que quer dizer é separar a responsabilidade de comandos e de queries. Quando a gente faz isso, aplica o CQRS, a gente faz com que cada serviço nosso, por exemplo, serviço de invoices, orders ou stock, ele fique responsável somente por comandos. Comandos é o que? Operações de escrita. Então, escrita aqui geralmente é create, update e delete. Isso quer dizer que esses carinhas aqui só vão ter operações rotas de escrita. Eles não vão ter rotas GET dentro deles para busca de dados. E aí, como é que a gente faz com a parte de leitura de dados? Nós temos um banco de dados, que vai conter várias View Tables, que são tabelas que não são populadas por Inserts, digamos assim. Elas são populadas automaticamente com bases em outros dados que a gente tem, em outros bancos de dados. E essas tabelas são populadas já da maneira que elas vão ser consumidas no back-end. Então, se eu preciso dar invoice URL dentro de orders, por exemplo, aqui dentro dos meus view tables, por exemplo, eu posso ter já uma tabela chamada orders with invoices, que ela vai ter os dados de id, order id, por exemplo, Ela vai ter o Customer Name, já os dados exatamente da maneira que eles vão precisar ser consumidos em algum momento. E aqui eu vou ter, por exemplo, a Invoice URL. E esses dados aqui, eles vão ser preenchidos automaticamente com base nos meus bancos de dados dos... dos serviços que têm esses dados aqui. E para preencher isso aqui, existem várias ferramentas. A gente tem ferramentas hoje que fazem um fluxo que a gente chama de Data Warehouse, que é o fluxo de consumir automaticamente inserções em outros bancos de dados, processar essas inserções e preencher um banco de dados à parte com esses dados para que eles sejam consumidos. E aqui, a gente vai ter... o nosso front-end fazendo requisições GET para o serviço com esta tabela aqui. E essa tabela é que guarda todas as informações para a gente consumir esses dados no formato correto. Isso aqui permite a gente aplicar também alguns outros conceitos e patterns que são comuns, como é o pattern, por exemplo, de event sourcing. Talvez você já tenha ouvido falar. Event Sourcing nada mais é do que um pattern usado também comumente dentro de microserviços, onde ao invés de a gente armazenar o dado no banco de dados aqui do serviço da maneira que ele vai ser lido, a gente armazena somente... os eventos que aconteceram naquele dado. Vamos usar o exemplo aqui do estoque. Ao invés de eu ter uma tabela, por exemplo, produtos, que eu tenho o título do produto e o tanto de estoque que eu tenho daquele produto, ao invés disso, eu tenho uma tabela, por exemplo, chamada ProductStockOperations. E aí eu tenho o ID do produto, por exemplo, e eu tenho o stock amount e a operação onde ela pode ser increase ou decrease e eu tenho um created at e aí eu tenho por exemplo imagina no caso de event sourcing eu tenho uma inserção onde o produto o id é 1 eu mudei então botar aqui o product id É igual a 1. Eu tive um stock amount 3 com uma operação de increase, que aconteceu hoje. Depois, para esse mesmo product id 1, eu tive uma operação com stock amount 1, que foi uma operação de decrease, que aconteceu hoje. Isso aqui aconteceu ontem, por exemplo. E aí, o que acontece? Veja que eu salvo no meu banco de dados apenas os eventos que aconteceram, e não os dados como eles vão ser lidos no final. E aí, quando eu vou salvando esses eventos aqui, se eu estou utilizando essa ideia de CQRS, esses eventos aqui são enviados lá para o meu banco de dados de leitura, que depois são convertidos para esse formato aqui. Então, o meu banco de dados de leitura O que ele vai fazer? Ele vai pegar o estado anterior... Então, houve um novo evento. Ele vai ler o estado anterior... Opa, aconteceu um decrease de 1 no produto com ID 1. Ele vai lá na tabela de products, de leitura aqui, e diminui o estoque. Ou seja, a gente separou, a gente fez uma segregação, a gente deixou com que os bancos de dados de cada serviço anotem eventos que aconteceram com aquela entidade, enquanto o nosso banco de dados de leitura anota as informações, como elas vão ser exibidas para o usuário final. Então, isso é mais ou menos o que acontece em Event Sourcing. E é um pattern muito utilizado dentro de microserviços, mas geralmente ele vai ser utilizado em combinação com CQRS. Não vale a pena muito utilizar ele separado, porque senão você vai ter que... fazer essas operações de converter essa estrutura de eventos para a maneira que ela vai ser lida dentro do próprio serviço. E aí, para de fazer um pouco de sentido, porque você acaba perdendo muita performance.
