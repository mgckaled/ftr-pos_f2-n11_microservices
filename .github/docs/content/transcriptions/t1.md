# Transcrição: 1. Microsserviços: Prós e Contras

Fala Devs, nessa aula a gente vai começar a falar sobre fundamentos de microserviços e essa primeira aula na verdade é pra gente desmistificar algumas coisas relacionadas a essa arquitetura, principalmente falar sobre mitos, sobre pros, contras, vantagens, desvantagens... Antes de mais nada, o que são microserviços? Microserviços é uma arquitetura principalmente de infraestrutura. Isso é muito importante, porque muita gente acha que microserviços impacta diretamente na arquitetura de código. Muitas vezes não, na maioria das vezes não. É uma arquitetura da forma que a gente faz deploy das nossas aplicações. Geralmente, microserviços tendem a ser basicamente um conjunto de aplicações de serviços que funcionam de forma independente. Isso é muito importante, independente, ou seja, quer dizer que se um serviço cair, os outros continuam funcionando normalmente, apesar de que, claro, aquele que caiu, aquele que não está respondendo, vai parar de processar as informações, os eventos que precisam ser processados ali. A microserviço, primeiramente, como eu falei, não depende de arquitetura de código, sim de infraestrutura. E para a gente entender que a gente realmente está criando microserviços, os serviços precisam ser independentemente implantáveis. Isso quer dizer que... Cada serviço, muitas das vezes, vai ter a sua própria forma de deploy, a sua própria estrutura de deploy, e também ele pode ter, inclusive, a sua própria tecnologia, seu próprio banco de dados. Um serviço pode estar utilizando o Mongo, outro serviço pode estar utilizando o Postgres, outro serviço pode estar utilizando o Redis, um serviço pode estar escrito em Go, outro serviço pode estar escrito em Node, outro serviço pode estar escrito em Java e por aí vai. E o mais importante de microserviços é que eles têm que ser pensados e modelados em torno de um domínio de negócio específico. Até por isso, muitas das vezes, quando as pessoas vão estudar micro-serviços, elas estudam junto a Domain Driven Design, que provavelmente é um tema que talvez você já tenha ouvido falar. Por quê? Lá dentro do Domain Driven Design, isso é uma das maiores dores das pessoas, que é como entender como que eu separo os meus serviços. A gente tem lá dentro do DDD os Bounded Contexts, que são as barreiras, fronteiras que separam os domínios, as áreas da nossa aplicação, da nossa empresa, e os bounded contexts são justamente as áreas separadas dentro de um sistema onde um modelo de domínio específico é aplicado, onde cada contexto tem as suas próprias regras e significados. O que isso quer dizer? Muitas vezes, quando a gente está criando uma aplicação muito grande, imagina um ERP, um CRM, uma aplicação grande que geralmente faz jus à separação, muitas vezes em microserviços, onde a gente tem um time muito grande, um e-commerce, um projeto realmente astronômico, onde faça jus ao uso de microserviços, a gente tem ali dentro uma operação muito grande. Então, quando a gente traz esse assunto de microserviços, microserviços não consegue ficar muito separado da parte de negócio da nossa empresa, assim como o domênio de event design também se conecta muito com a área de negócio da nossa empresa. Isso porque quando a gente tem lá, por exemplo, na nossa empresa área de atendimento, uma área de financeiro, uma área de faturamento, uma área de produto, todas essas pessoas, apesar de muitas vezes elas estarem falando de coisas semelhantes, elas usam terminologias diferentes, elas usam métodos diferentes para explicar, para chegar no resultado. Então, enquanto uma pessoa trata a área de produto, vai tratar os clientes como usuários, a área de atendimento e logística vai tratar como cliente e por aí vai. Então, a gente tem nomes diferentes e terminologias diferentes para cada área aplicada dentro da nossa empresa. Então, como eu falei, um exemplo, um sistema de vendas e estoque produto pode ter significados diferentes. Em vendas, ele pode se referir a uma oferta. Em estoque, ele pode se referir a um item físico mesmo. Ah, fui lá e peguei o produto do meu estoque. Isso, para quem trabalha com faturamento, emissão de nota fiscal, é um produto físico mesmo. Então, isso é muito importante a gente entender que microserviços é muito conectado à estrutura de negócio da nossa empresa. E aí, antes de mais nada, quais são as vantagens da gente aplicar microserviços? Primeiro, a gente tem uma infraestrutura específica por necessidade do serviço. Então, imagina que nós estamos construindo aqui... Deixa eu tirar um pouco de zoom aqui, senão vai ficar muito grande. Imagina que a gente está criando aqui um microserviço de encurtamento de URL. Então, a gente separa aqui a nossa aplicação em dois serviços. Então, imagina que a gente tenha um serviço especializado em encurtamento de URL, e a gente tem um serviço especializado em analíticas. E, geralmente, essa separação tende a ser proveitosa para a gente quando a gente está utilizando microserviços, porque, por exemplo, esse serviço de shortener aqui, imagina que ele vai ter apenas uma tabela no banco de dados com os links encurtados, então ele vai ter uma tabela lá que tem o link original, E ele tem ali o shortcode, que seria o que vem na URL. Então, encurta.com, imagina... Que é o que vem aqui logo depois da URL, que vai redirecionar o usuário lá para dentro da URL original. Nesse caso aqui, imagina que esse shortener pode estar utilizando um banco de dados, um Mongo da vida, um banco de dados não relacional, algo que seja mais simples do que uma estrutura de Postgres, por exemplo, Agora, quando a gente vem para o serviço de Analytics, eu vou provavelmente precisar de um banco de dados específico para Analytics, para a gente fazer Time Series, alguma coisa assim... Então, aqui eu poderia estar usando um Clickhouse, por exemplo, que é basicamente uma extensão em cima do Postgres ali, focado em Analytics. Então, veja que a partir do momento que eu tenho microserviços, eu tenho essa abertura para eu fazer a separação dos meus serviços e a infraestrutura e as tecnologias de forma totalmente isolada por serviço. E isso garante também que eu tenha uma escalabilidade direcionada por serviço. Isso quer dizer que... Imagina que o usuário que está chegando aqui... Então, eu tenho um front-end... na minha aplicação, imagina que esse front-end aqui vai ser responsável pela criação de URLs, então o usuário tem uma página onde ele cria URLs, que se comunica via HTTP diretamente com o serviço aqui de encurtamento, só que a partir do momento que esse serviço de encurtamento que a URL foi encurtada, que ela foi criada, todas as demais requisições dos demais usuários aqui... Imagina que eu tenha 100 milhões de usuários que vão estar acessando essa URL, eu vou estar disparando 100 milhões de requisições aqui para o serviço de Analytics, porque é ele que vai contar cada um dos acessos, cada um dos cliques que a gente tiver nesse link, vai anotar qual é o navegador, o IP, o ambiente, o sistema operacional, para a gente ter essas métricas depois. E por isso que, geralmente, quando a gente tem uma arquitetura de microserviços, ela tem uma grande vantagem para a gente, que a gente pode escalar esses serviços de forma individual, a gente não precisa ter um monolito que a gente escala tudo ao mesmo tempo. Então, imagina que esse serviço aqui está operando em uma máquina com 1.4 vCPU e com... 256 MB de RAM, por exemplo, que seria uma máquina super simples lá dentro da AWS, né? E aí, com o momento, eu começo a receber muitos acessos, eu posso, primeiro, fazer um escolaramento horizontal, né? Então, colocar quatro máquinas aqui operando, uma ao lado... uma ao lado da outra distribuindo a carga né entre esses esses acessos 100 milhões de acessos aqui enquanto o serviço de shortener aqui ele pode continuar com uma única máquina porque ele tá recebendo apenas requisições de criação de novas urls então Isso aqui é uma vantagem muito legal de microservice. Outra coisa muito legal de microservice é que quando você trabalha com um time muito grande, e geralmente microservice só faz sentido em empresas que são muito grandes, que tem uma quantidade anormal de pessoas ali trabalhando... Então, imagina uma empresa com pelo menos 500, 600 funcionários devs, que eu estou falando com pessoas devs trabalhando ali no código, Imagina que a gente ter um único grande repositório, uma única grande codebase para toda a nossa aplicação, começa a se tornar arriscado, porque imagina você começa a ter conflito entre pull requests, entre branches, muito conflito ali dentro do código... Então, você acaba... Quando você acaba separando a sua aplicação em vários projetinhos menores, você consegue ter um desenvolvimento paralelo mais fluido, você consegue ter pessoas trabalhando em cada parte do projeto de forma individual, porque cada projeto, como eu falei, ele deve ser visto como um projeto, como um serviço independentemente implantável, ou seja, um serviço onde a pessoa pode fazer deploy de novas versões, sem danificar o restante do funcionamento das outras aplicações. Mas claro, para isso acontecer, existe uma série de regras que a gente tem que seguir quando a gente trabalha com micro-serviços. Mas nem tudo são flores, na verdade, a maioria quando a gente trabalha com micro-serviços, na verdade, não são flores, a maioria são desafios, porque micro-serviços... Por mais que tenha essas vantagens que são incríveis, tudo o que a gente tem de complexidade dentro de um serviço, a gente vai ter... Imagina que você está desenvolvendo um monolito, você tinha alguns problemas ali dentro, toda essa complexidade vai ser distribuída numa escala de... O vezes N. Basicamente, você tem para cada novo serviço a complexidade de lidar com latência, com debug, com observabilidade, com tracing, com a parte de transações. Então, tudo isso vai se tornando um desafio. Todos esses desafios que a gente já tem ao manter uma aplicação no ar com um monolito. Então, imagina, está dando erro, tem que olhar para logs, tem que olhar para observabilidade, tem que olhar para... memória RAM, CPU, eu vou ter isso multiplicado vezes N para cada um dos serviços que eu tiver ali dentro. Mas isso não é ainda o único desafio, esse é um desafio que você pode pensar... Bom, vou deixar ali para o pessoal de DevOps se preocupar com isso, mas você, como deve, também tem uma dificuldade muito grande que é a parte de consistência de dados, por exemplo. Então, imagina que o seguinte... A gente tem aqui esse serviço de encurtamento de URL. Quando o usuário cria uma URL, nós precisamos avisar o serviço aqui de Analytics que essa URL foi criada. Por quê? Porque desta forma, quando alguém acessar alguma URL, eu consigo aqui no Analytics anotar, por exemplo, que este link aqui... Então, imagina que aqui eu tenho um id, Então, aqui que está salvo nesse Mongo. Aqui dentro do Analytics, eu tenho que ter uma tabela, por exemplo, url clicks, que ela vai ter o url id, que é, na verdade, uma referência para este banco de dados aqui, para o id que está aqui no Mongo, e, por exemplo, a quantidade de click. Então, click count. Deixa eu até tirar isso aqui para não confundir. Então, veja que quando eu trabalho com vários serviços, a gente tem que cuidar porque existe esse problema, essa questão da consistência dos dados, porque se nessa tabela aqui eu tivesse algum outro campo da URL, não só o id, imagina que eu tivesse aqui também o shortcode por algum motivo que seja, Se esse shortcode mudasse em algum momento aqui no Mongo, eu teria que refletir essa alteração aqui dentro desse serviço. E quando eu penso só em dois serviços, isso pode ser tranquilo, mas quando eu penso que eu posso ter 50, posso ter 100, posso ter mil microserviços, refletir, ter a consistência dos dados entre esses vários serviços, ela começa a se tornar um desafio bem grande. Até porque quando a gente trabalha com microserviços, isso é uma coisa que a gente vai falar ainda mais para frente e com mais detalhe, cada serviço vai ter o seu banco de dados. Mas eu posso ter o mesmo banco de dados separado, o mesmo banco de dados para dois serviços? Ou um serviço pode ler direto do banco de dados de outro serviço? Não, a ideia é que se você está fazendo isso, provavelmente você não está implementando microserviços, E a chance de dar uma merda é muito grande. Então, tem que cuidar bastante com isso. Por isso que quando a gente trabalha com microservices, toda a comunicação feita entre os serviços, ela é feita através de protocolos que a gente já está acostumado. Então, a gente pode ter, por exemplo, protocolo HTTP, gRPC, a gente pode também... ter comunicação assíncrona usando Kafka, usando RabbitMQ, usando até Redis em alguns casos é possível. Então, a gente vai falar bastante sobre isso, sobre como que a gente faz comunicação entre micro-serviços aqui ao longo das próximas aulas. Mas... Como eu falei, o microserviço torna tudo mais difícil. A gente tem fluxos de CI e CD repetidos para cada serviço, todo fluxo de monitoramento... Então, tem bastante coisa que a gente tem que lidar, mas claro, é um assunto que vale super a pena você estudar sobre, porque claro, boa parte das empresas, se você for trabalhar em empresas maiores, você vai ter que lidar com times, com arquiteturas de microserviços e isso é importante você ter esse conhecimento na manga para quando você for utilizar, para quando você cair na aplicação disso, você saiba exatamente como tratar cada uma dessas situações. Então, bora lá entender um pouquinho mais a fundo.
